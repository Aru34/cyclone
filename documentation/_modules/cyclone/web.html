<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cyclone.web &mdash; cyclone git-2013042301 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'git-2013042301',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="cyclone git-2013042301 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">cyclone git-2013042301 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for cyclone.web</h1><div class="highlight"><pre>
<span class="c"># coding: utf-8</span>
<span class="c">#</span>
<span class="c"># Copyright 2010 Alexandre Fiori</span>
<span class="c"># based on the original Tornado by Facebook</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c"># not use this file except in compliance with the License. You may obtain</span>
<span class="c"># a copy of the License at</span>
<span class="c">#</span>
<span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c"># License for the specific language governing permissions and limitations</span>
<span class="c"># under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The cyclone web framework looks a bit like web.py (http://webpy.org/) or</span>
<span class="sd">Google&#39;s webapp (http://code.google.com/appengine/docs/python/tools/webapp/),</span>
<span class="sd">but with additional tools and optimizations to take advantage of the</span>
<span class="sd">non-blocking web server and tools.</span>

<span class="sd">Here is the canonical &quot;Hello, world&quot; example app::</span>

<span class="sd">    import cyclone.web</span>
<span class="sd">    from twisted.internet import reactor</span>

<span class="sd">    class MainHandler(cyclone.web.RequestHandler):</span>
<span class="sd">        def get(self):</span>
<span class="sd">            self.write(&quot;Hello, world&quot;)</span>

<span class="sd">    if __name__ == &quot;__main__&quot;:</span>
<span class="sd">        application = cyclone.web.Application([</span>
<span class="sd">            (r&quot;/&quot;, MainHandler),</span>
<span class="sd">        ])</span>
<span class="sd">        reactor.listenTCP(8888, application)</span>
<span class="sd">        reactor.run()</span>

<span class="sd">See the cyclone walkthrough on http://cyclone.io for more details and a good</span>
<span class="sd">getting started guide.</span>

<span class="sd">Thread-safety notes</span>
<span class="sd">-------------------</span>

<span class="sd">In general, methods on RequestHandler and elsewhere in cyclone are not</span>
<span class="sd">thread-safe.  In particular, methods such as write(), finish(), and</span>
<span class="sd">flush() must only be called from the main thread.  For more information on</span>
<span class="sd">using threads, please check the twisted documentation:</span>
<span class="sd">http://twistedmatrix.com/documents/current/core/howto/threading.html</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">with_statement</span>

<span class="kn">import</span> <span class="nn">Cookie</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">email.utils</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">cyclone</span>
<span class="kn">from</span> <span class="nn">cyclone</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">cyclone</span> <span class="kn">import</span> <span class="n">httpserver</span>
<span class="kn">from</span> <span class="nn">cyclone</span> <span class="kn">import</span> <span class="n">locale</span>
<span class="kn">from</span> <span class="nn">cyclone</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">cyclone.escape</span> <span class="kn">import</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">_unicode</span>
<span class="kn">from</span> <span class="nn">cyclone.util</span> <span class="kn">import</span> <span class="n">ObjectDict</span>
<span class="kn">from</span> <span class="nn">cyclone.util</span> <span class="kn">import</span> <span class="n">bytes_type</span>
<span class="kn">from</span> <span class="nn">cyclone.util</span> <span class="kn">import</span> <span class="n">import_object</span>
<span class="kn">from</span> <span class="nn">cyclone.util</span> <span class="kn">import</span> <span class="n">unicode_type</span>

<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span> <span class="k">as</span> <span class="n">BytesIO</span>  <span class="c"># python 2</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">failure</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>


<div class="viewcode-block" id="RequestHandler"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler">[docs]</a><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass this class and define get() or post() to make a handler.</span>

<span class="sd">    If you want to support more methods than the standard GET/HEAD/POST, you</span>
<span class="sd">    should override the class variable SUPPORTED_METHODS in your</span>
<span class="sd">    RequestHandler class.</span>

<span class="sd">    If you want lists to be serialized when calling self.write() set</span>
<span class="sd">    serialize_lists to True.</span>
<span class="sd">    This may have some security implications if you are not protecting against</span>
<span class="sd">    XSRF with other means (such as a XSRF token).</span>
<span class="sd">    More details on this vulnerability here:</span>
<span class="sd">    http://haacked.com/archive/2008/11/20/anatomy-of-a-subtle-json-vulnerability.aspx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SUPPORTED_METHODS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s">&quot;PATCH&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span>
                         <span class="s">&quot;OPTIONS&quot;</span><span class="p">)</span>

    <span class="n">serialize_lists</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">no_keep_alive</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">xsrf_cookie_name</span> <span class="o">=</span> <span class="s">&quot;_xsrf&quot;</span>
    <span class="n">_template_loaders</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># {path: template.BaseLoader}</span>
    <span class="n">_template_loader_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_finish</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># will be set in _execute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_args</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_kwargs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">ObjectDict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ui_method</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span>
                     <span class="n">application</span><span class="o">.</span><span class="n">ui_methods</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="c"># UIModules are available as both `modules` and `_modules` in the</span>
        <span class="c"># template namespace.  Historically only `modules` was available</span>
        <span class="c"># but could be clobbered by user additions to the namespace.</span>
        <span class="c"># The template {% module %} directive looks in `_modules` to avoid</span>
        <span class="c"># possible conflicts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">[</span><span class="s">&quot;_modules&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectDict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ui_module</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span>
                                 <span class="n">application</span><span class="o">.</span><span class="n">ui_modules</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">[</span><span class="s">&quot;modules&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">[</span><span class="s">&quot;_modules&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">no_keep_alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_keep_alive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="RequestHandler.initialize"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hook for subclass initialization.</span>

<span class="sd">        A dictionary passed as the third argument of a url spec will be</span>
<span class="sd">        supplied as keyword arguments to initialize().</span>

<span class="sd">        Example::</span>

<span class="sd">            class ProfileHandler(RequestHandler):</span>
<span class="sd">                def initialize(self, database):</span>
<span class="sd">                    self.database = database</span>

<span class="sd">                def get(self, username):</span>
<span class="sd">                    ...</span>

<span class="sd">            app = Application([</span>
<span class="sd">                (r&#39;/user/(.*)&#39;, ProfileHandler, dict(database=database)),</span>
<span class="sd">                ])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="RequestHandler.settings"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.settings">[docs]</a>    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An alias for `self.application.settings`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span>
</div>
<div class="viewcode-block" id="RequestHandler.default"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when a request does not match any implemented methods.</span>

<span class="sd">        Example::</span>

<span class="sd">            class ExampleHandler(RequestHandler):</span>
<span class="sd">                def get(self):</span>
<span class="sd">                    self.write(&#39;That was a GET request!&#39;)</span>

<span class="sd">                def default(self):</span>
<span class="sd">                    self.write(&#39;That was anything but a GET request!&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">405</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.prepare"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called at the beginning of a request before `get`/`post`/etc.</span>

<span class="sd">        Override this method to perform common initialization regardless</span>
<span class="sd">        of the request method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="RequestHandler.on_finish"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.on_finish">[docs]</a>    <span class="k">def</span> <span class="nf">on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after the end of a request.</span>

<span class="sd">        Override this method to perform cleanup, logging, etc.</span>
<span class="sd">        This method is a counterpart to `prepare`.  ``on_finish`` may</span>
<span class="sd">        not produce any output, as it is called after the response</span>
<span class="sd">        has been sent to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="RequestHandler.on_connection_close"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.on_connection_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called in async handlers if the client closed the connection.</span>

<span class="sd">        Override this to clean up resources associated with</span>
<span class="sd">        long-lived connections.  Note that this method is called only if</span>
<span class="sd">        the connection was closed during asynchronous processing; if you</span>
<span class="sd">        need to do cleanup after every request override `on_finish`</span>
<span class="sd">        instead.</span>

<span class="sd">        Proxies may keep a connection open for a time (perhaps</span>
<span class="sd">        indefinitely) after the client has gone away, so this method</span>
<span class="sd">        may not be called promptly after the end user closes their</span>
<span class="sd">        connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="RequestHandler.clear"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resets all headers and content for this response.&quot;&quot;&quot;</span>
        <span class="c"># The performance cost of cyclone.httputil.HTTPHeaders is significant</span>
        <span class="c"># (slowing down a benchmark with a trivial handler by more than 10%),</span>
        <span class="c"># and its case-normalization is not generally necessary for</span>
        <span class="c"># headers we generate on the server side, so use a plain dict</span>
        <span class="c"># and list instead.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;Server&quot;</span><span class="p">:</span> <span class="s">&quot;cyclone/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cyclone</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="p">,</span>
            <span class="s">&quot;Date&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                                                <span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default_headers</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">supports_http_1_1</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Connection&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;Keep-Alive&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Connection&quot;</span><span class="p">,</span> <span class="s">&quot;Keep-Alive&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RequestHandler.set_default_headers"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.set_default_headers">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override this to set HTTP headers at the beginning of the request.</span>

<span class="sd">        For example, this is the place to set a custom ``Server`` header.</span>
<span class="sd">        Note that setting such headers in the normal flow of request</span>
<span class="sd">        processing may not do what you want, since headers may be reset</span>
<span class="sd">        during error handling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="RequestHandler.set_status"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the status code for our response.</span>

<span class="sd">        :arg int status_code: Response status code. If `reason` is ``None``,</span>
<span class="sd">            it must be present in `httplib.responses`.</span>
<span class="sd">        :arg string reason: Human-readable reason phrase describing the status</span>
<span class="sd">            code. If ``None``, it will be filled in from `httplib.responses`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown status code </span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_status"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the status code for our response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>
</div>
<div class="viewcode-block" id="RequestHandler.set_header"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.set_header">[docs]</a>    <span class="k">def</span> <span class="nf">set_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the given response header name and value.</span>

<span class="sd">        If a datetime is given, we automatically format it according to the</span>
<span class="sd">        HTTP specification. If the value is not a string, we convert it to</span>
<span class="sd">        a string. All header values are then encoded as UTF-8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.add_header"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.add_header">[docs]</a>    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the given response header and value.</span>

<span class="sd">        Unlike `set_header`, `add_header` may be called multiple times</span>
<span class="sd">        to return multiple values for the same header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="RequestHandler.clear_header"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.clear_header">[docs]</a>    <span class="k">def</span> <span class="nf">clear_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears an outgoing header, undoing a previous `set_header` call.</span>

<span class="sd">        Note that this method does not apply to multi-valued headers</span>
<span class="sd">        set by `add_header`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_convert_header_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="c"># return immediately since we know the converted value will be safe</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">formatdate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">localtime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">usegmt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Unsupported header value </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="c"># If \n is allowed into the header, it is possible to inject</span>
        <span class="c"># additional headers or split the request. Also cap length to</span>
        <span class="c"># prevent obviously erroneous values.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4000</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;[\x00-\x1f]&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unsafe header value </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">_ARG_DEFAULT</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RequestHandler.get_argument"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_argument">[docs]</a>    <span class="k">def</span> <span class="nf">get_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_ARG_DEFAULT</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the value of the argument with the given name.</span>

<span class="sd">        If default is not provided, the argument is considered to be</span>
<span class="sd">        required, and we throw an HTTP 400 exception if it is missing.</span>

<span class="sd">        If the argument appears in the url more than once, we return the</span>
<span class="sd">        last value.</span>

<span class="sd">        The returned value is always unicode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_arguments</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ARG_DEFAULT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;Missing argument &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_arguments"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">get_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of the arguments with the given name.</span>

<span class="sd">        If the argument is not present, returns an empty list.</span>

<span class="sd">        The returned values are always unicode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
                <span class="c"># Get rid of any weird control chars (unless decoding gave</span>
                <span class="c"># us bytes, in which case leave it alone)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;[\x00-\x08\x0e-\x1f]&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>
</div>
<div class="viewcode-block" id="RequestHandler.decode_argument"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.decode_argument">[docs]</a>    <span class="k">def</span> <span class="nf">decode_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decodes an argument from the request.</span>

<span class="sd">        The argument has been percent-decoded and is now a byte string.</span>
<span class="sd">        By default, this method decodes the argument as utf-8 and returns</span>
<span class="sd">        a unicode string, but this may be overridden in subclasses.</span>

<span class="sd">        This method is used as a filter for both get_argument() and for</span>
<span class="sd">        values extracted from the url and passed to get()/post()/etc.</span>

<span class="sd">        The name of the argument is provided if known, but may be None</span>
<span class="sd">        (e.g. for unnamed groups in the url regex).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="RequestHandler.cookies"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.cookies">[docs]</a>    <span class="k">def</span> <span class="nf">cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_cookie"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">get_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the value of the cookie with the given name, else default.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">default</span>
</div>
<div class="viewcode-block" id="RequestHandler.set_cookie"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.set_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span>
                   <span class="n">expires_days</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the given cookie name/value with the given options.</span>

<span class="sd">        Additional keyword arguments are set on the Cookie.Morsel directly.</span>
<span class="sd">        See http://docs.python.org/library/cookie.html#morsel-objects</span>
<span class="sd">        for available attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># The cookie library only accepts type str, in both python 2 and 3</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;[\x00-\x20]&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">value</span><span class="p">):</span>
            <span class="c"># Don&#39;t let us accidentally inject bad stuff</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid cookie </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_new_cookie&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span> <span class="o">=</span> <span class="n">Cookie</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">morsel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">morsel</span><span class="p">[</span><span class="s">&quot;domain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="k">if</span> <span class="n">expires_days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                                                        <span class="n">days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">expires</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
            <span class="n">morsel</span><span class="p">[</span><span class="s">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">formatdate</span><span class="p">(</span>
                                    <span class="n">timestamp</span><span class="p">,</span> <span class="n">localtime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">usegmt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">morsel</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;max_age&#39;</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s">&#39;max-age&#39;</span>
            <span class="n">morsel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</div>
<div class="viewcode-block" id="RequestHandler.clear_cookie"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.clear_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">clear_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the cookie with the given name.&quot;&quot;&quot;</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span>
                        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.clear_all_cookies"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.clear_all_cookies">[docs]</a>    <span class="k">def</span> <span class="nf">clear_all_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes all the cookies the user sent with this request.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.set_secure_cookie"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.set_secure_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">set_secure_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expires_days</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signs and timestamps a cookie so it cannot be forged.</span>

<span class="sd">        You must specify the ``cookie_secret`` setting in your Application</span>
<span class="sd">        to use this method. It should be a long, random sequence of bytes</span>
<span class="sd">        to be used as the HMAC secret for the signature.</span>

<span class="sd">        To read a cookie set with this method, use `get_secure_cookie()`.</span>

<span class="sd">        Note that the ``expires_days`` parameter sets the lifetime of the</span>
<span class="sd">        cookie in the browser, but is independent of the ``max_age_days``</span>
<span class="sd">        parameter to `get_secure_cookie`.</span>

<span class="sd">        Secure cookies may contain arbitrary byte values, not just unicode</span>
<span class="sd">        strings (unlike regular cookies)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_signed_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
                        <span class="n">expires_days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.create_signed_value"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.create_signed_value">[docs]</a>    <span class="k">def</span> <span class="nf">create_signed_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signs and timestamps a string so it cannot be forged.</span>

<span class="sd">        Normally used via set_secure_cookie, but provided as a separate</span>
<span class="sd">        method for non-cookie uses.  To decode a value not stored</span>
<span class="sd">        as a cookie use the optional value argument to get_secure_cookie.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">,</span> <span class="s">&quot;secure cookies&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_signed_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">],</span>
                                   <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_secure_cookie"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_secure_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">get_secure_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="mi">31</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the given signed cookie if it validates, or None.</span>

<span class="sd">        The decoded cookie value is returned as a byte string (unlike</span>
<span class="sd">        `get_cookie`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">,</span> <span class="s">&quot;secure cookies&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decode_signed_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">],</span>
                                   <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="n">max_age_days</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.redirect"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.redirect">[docs]</a>    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a redirect to the given (optionally relative) URL.</span>

<span class="sd">        If the ``status`` argument is specified, that value is used as the</span>
<span class="sd">        HTTP status code; otherwise either 301 (permanent) or 302</span>
<span class="sd">        (temporary) is chosen based on the ``permanent`` argument.</span>
<span class="sd">        The default is 302 (temporary).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Cannot redirect after headers have been written&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">301</span> <span class="k">if</span> <span class="n">permanent</span> <span class="k">else</span> <span class="mi">302</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">300</span> <span class="o">&lt;=</span> <span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">399</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="c"># Remove whitespace</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;[\x00-\x20]+&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">utf8</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">request_uri</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
            <span class="n">request_uri</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">request_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Location&quot;</span><span class="p">,</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">request_uri</span><span class="p">),</span>
                                                     <span class="n">url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RequestHandler.write"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the given chunk to the output buffer.</span>

<span class="sd">        To write the output to the network, use the flush() method below.</span>

<span class="sd">        If the given chunk is a dictionary, we write it as JSON and set</span>
<span class="sd">        the Content-Type of the response to be application/json.</span>
<span class="sd">        (if you want to send JSON as a different Content-Type, call</span>
<span class="sd">        set_header *after* calling write()).</span>

<span class="sd">        Note that lists are not converted to JSON because of a potential</span>
<span class="sd">        cross-site security vulnerability.  All JSON output should be</span>
<span class="sd">        wrapped in a dictionary.  More details at</span>
<span class="sd">        http://haacked.com/archive/2008/11/20/\</span>
<span class="sd">            anatomy-of-a-subtle-json-vulnerability.aspx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Cannot write() after finish().  May be caused &quot;</span>
                               <span class="s">&quot;by using async operations without the &quot;</span>
                               <span class="s">&quot;@asynchronous decorator.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialize_lists</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">)):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.render"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders the template with the given arguments as the response.&quot;&quot;&quot;</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Insert the additional JS and CSS added by the modules on the page</span>
        <span class="n">js_embed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">js_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">css_embed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">css_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">html_heads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">html_bodies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_active_modules&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">embed_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">embedded_javascript</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">embed_part</span><span class="p">:</span>
                <span class="n">js_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">embed_part</span><span class="p">))</span>
            <span class="n">file_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">javascript_files</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">file_part</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_part</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)):</span>
                    <span class="n">js_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_part</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">js_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">file_part</span><span class="p">)</span>
            <span class="n">embed_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">embedded_css</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">embed_part</span><span class="p">:</span>
                <span class="n">css_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">embed_part</span><span class="p">))</span>
            <span class="n">file_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">css_files</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">file_part</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_part</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)):</span>
                    <span class="n">css_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_part</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">css_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">file_part</span><span class="p">)</span>
            <span class="n">head_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">html_head</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">head_part</span><span class="p">:</span>
                <span class="n">html_heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">head_part</span><span class="p">))</span>
            <span class="n">body_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">html_body</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">body_part</span><span class="p">:</span>
                <span class="n">html_bodies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">body_part</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">is_absolute</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;http:&quot;</span><span class="p">,</span> <span class="s">&quot;https:&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">js_files</span><span class="p">:</span>
            <span class="c"># Maintain order of JavaScript files given by modules</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">unique_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">js_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_absolute</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_paths</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">unique_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">js</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;&lt;script src=&quot;&#39;</span> <span class="o">+</span> <span class="n">escape</span><span class="o">.</span><span class="n">xhtml_escape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s">&#39;&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;&#39;</span>
                         <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">)</span>
            <span class="n">sloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;&lt;/body&gt;&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">sloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">utf8</span><span class="p">(</span><span class="n">js</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">sloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">js_embed</span><span class="p">:</span>
            <span class="n">js</span> <span class="o">=</span> <span class="s">&#39;&lt;script type=&quot;text/javascript&quot;&gt;</span><span class="se">\n</span><span class="s">//&lt;![CDATA[</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> \
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">js_embed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">//]]&gt;</span><span class="se">\n</span><span class="s">&lt;/script&gt;&#39;</span>
            <span class="n">sloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;&lt;/body&gt;&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">sloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">js</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">sloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">css_files</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">unique_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">css_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_absolute</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_paths</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">unique_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">css</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;&lt;link href=&quot;&#39;</span> <span class="o">+</span> <span class="n">escape</span><span class="o">.</span><span class="n">xhtml_escape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot; &#39;</span>
                          <span class="s">&#39;type=&quot;text/css&quot; rel=&quot;stylesheet&quot;/&gt;&#39;</span>
                          <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">)</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;&lt;/head&gt;&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">utf8</span><span class="p">(</span><span class="n">css</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">css_embed</span><span class="p">:</span>
            <span class="n">css</span> <span class="o">=</span> <span class="s">&#39;&lt;style type=&quot;text/css&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">css_embed</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&lt;/style&gt;&#39;</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;&lt;/head&gt;&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">css</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">html_heads</span><span class="p">:</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;&lt;/head&gt;&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_heads</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">html_bodies</span><span class="p">:</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;&lt;/body&gt;&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_bodies</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.render_string"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.render_string">[docs]</a>    <span class="k">def</span> <span class="nf">render_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the given template with the given arguments.</span>

<span class="sd">        We return the generated string. To generate and write a template</span>
<span class="sd">        as a response, use render() above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># If no template_path is specified, use the path of the calling file</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">template_path</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">web_file</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
            <span class="k">while</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">==</span> <span class="n">web_file</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loader_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">template_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="p">:</span>
                <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_template_loader</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span>
                <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="p">[</span><span class="n">template_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">loader</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loader</span> <span class="o">=</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="p">[</span><span class="n">template_path</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_namespace</span><span class="p">()</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">namespace</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_template_namespace"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_template_namespace">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary to be used as the default template namespace.</span>

<span class="sd">        May be overridden by subclasses to add or modify values.</span>

<span class="sd">        The results of this method will be combined with additional</span>
<span class="sd">        defaults in the `tornado.template` module and keyword arguments</span>
<span class="sd">        to `render` or `render_string`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="n">current_user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span>
            <span class="n">_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span>
            <span class="n">static_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">static_url</span><span class="p">,</span>
            <span class="n">xsrf_form_html</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_form_html</span><span class="p">,</span>
            <span class="n">reverse_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span>
        <span class="p">)</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namespace</span>
</div>
<div class="viewcode-block" id="RequestHandler.create_template_loader"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.create_template_loader">[docs]</a>    <span class="k">def</span> <span class="nf">create_template_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a new template loader for the given path.</span>

<span class="sd">        May be overridden by subclasses.  By default returns a</span>
<span class="sd">        directory-based loader on the given path, using the</span>
<span class="sd">        ``autoescape`` application setting.  If a ``template_loader``</span>
<span class="sd">        application setting is supplied, uses that instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span>
        <span class="k">if</span> <span class="s">&quot;template_loader&quot;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;template_loader&quot;</span><span class="p">]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s">&quot;autoescape&quot;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="c"># autoescape=None means &quot;no escaping&quot;, so we have to be sure</span>
            <span class="c"># to only pass this kwarg if the user asked for it.</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;autoescape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;autoescape&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">Loader</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.flush"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_footers</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flushes the current output buffer to the network.&quot;&quot;&quot;</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">=</span> \
                    <span class="n">transform</span><span class="o">.</span><span class="n">transform_first_chunk</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">include_footers</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">transform_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">include_footers</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># Ignore the chunk and only write the headers for HEAD requests</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">or</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">headers</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">notifyFinish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a deferred, which is fired when the request is terminated</span>
<span class="sd">        and the connection is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">notifyFinish</span><span class="p">()</span>

<div class="viewcode-block" id="RequestHandler.finish"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes this response, ending the HTTP request.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;finish() called twice.  May be caused &quot;</span>
                               <span class="s">&quot;by using async operations without the &quot;</span>
                               <span class="s">&quot;@asynchronous decorator.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c"># Automatically support ETags and add the Content-Length header if</span>
        <span class="c"># we have not flushed any content yet.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s">&quot;Etag&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">):</span>
                <span class="n">etag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_etag</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">etag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Etag&quot;</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
                    <span class="n">inm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;If-None-Match&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inm</span> <span class="ow">and</span> <span class="n">inm</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">etag</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">,</span> <span class="s">&quot;Cannot send body with 304&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clear_headers_for_304</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s">&quot;Content-Length&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">content_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="n">content_length</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">include_footers</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RequestHandler.send_error"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.send_error">[docs]</a>    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends the given HTTP error code to the browser.</span>

<span class="sd">        If `flush()` has already been called, it is not possible to send</span>
<span class="sd">        an error, so this method will simply terminate the response.</span>
<span class="sd">        If output has been written but not yet flushed, it will be discarded</span>
<span class="sd">        and replaced with the error page.</span>

<span class="sd">        Override `write_error()` to customize the error page that is returned.</span>
<span class="sd">        Additional keyword arguments are passed through to `write_error`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Cannot send error response after headers written&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&quot;exc_info&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;exc_info&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span>
        <span class="k">elif</span> <span class="s">&quot;exception&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;exception&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">HTTPAuthenticationRequired</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;WWW-Authenticate&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">auth_type</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Uncaught exception in write_error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RequestHandler.write_error"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.write_error">[docs]</a>    <span class="k">def</span> <span class="nf">write_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override to implement custom error pages.</span>

<span class="sd">        ``write_error`` may call `write`, `render`, `set_header`, etc</span>
<span class="sd">        to produce output as usual.</span>

<span class="sd">        If this error was caused by an uncaught exception (including</span>
<span class="sd">        HTTPError), an ``exc_info`` triple will be available as</span>
<span class="sd">        ``kwargs[&quot;exc_info&quot;]``.  Note that this exception may not be</span>
<span class="sd">        the &quot;current&quot; exception for purposes of methods like</span>
<span class="sd">        ``sys.exc_info()`` or ``traceback.format_exc``.</span>

<span class="sd">        For historical reasons, if a method ``get_error_html`` exists,</span>
<span class="sd">        it will be used instead of the default ``write_error`` implementation.</span>
<span class="sd">        ``get_error_html`` returned a string instead of producing output</span>
<span class="sd">        normally, and had different semantics for exception handling.</span>
<span class="sd">        Users of ``get_error_html`` are encouraged to convert their code</span>
<span class="sd">        to override ``write_error`` instead.</span>

<span class="sd">        In order for error pages to be generated for paths that do not match any</span>
<span class="sd">        handlers, you can use the `error_handler` keyword argument when</span>
<span class="sd">        instantiating the ``cyclone.web.Application`` object.</span>

<span class="sd">        For example::</span>

<span class="sd">            import cyclone.web</span>
<span class="sd">            import httplib</span>

<span class="sd">            class CustomErrorPageMixin(object):</span>
<span class="sd">                def write_error(self, status_code, **kwargs):</span>
<span class="sd">                    kwargs[&quot;code&quot;] = status_code</span>
<span class="sd">                    if &#39;message&#39; not in kwargs:</span>
<span class="sd">                        kwargs[&quot;message&quot;] = httplib.responses[status_code]</span>

<span class="sd">                    try:</span>
<span class="sd">                        self.render(&quot;error_%d.html&quot; % status_code,</span>
<span class="sd">                                fields=kwargs)</span>
<span class="sd">                    except IOError:</span>
<span class="sd">                        self.render(&quot;error_all.html&quot;, fields=kwargs)</span>

<span class="sd">            class CustomErrorHandler(CustomErrorPageMixin,</span>
<span class="sd">                    cyclone.web.ErrorHandler):</span>
<span class="sd">                pass</span>

<span class="sd">            class BaseHandler(CustomErrorPageMixin, cyclone.web.RequestHandler):</span>
<span class="sd">                ...</span>

<span class="sd">        Then, when constructing the ``cyclone.web.Application`` object::</span>

<span class="sd">            from cyclone import web</span>
<span class="sd">            application = web.Application([</span>
<span class="sd">                (r&quot;/&quot;, MainPageHandler),</span>
<span class="sd">            ], error_handler=CustomErrorHandler)</span>

<span class="sd">        This technique is also compatible with Bottle-style applications::</span>

<span class="sd">            from cyclone.bottle import create_app</span>
<span class="sd">            # create_app takes the same arguments as run</span>
<span class="sd">            application = create_app(base_handler=BaseHandler,</span>
<span class="sd">                error_handler=CustomErrorHandler)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_error_html&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;exc_info&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;exc_info&#39;</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;exception&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># Put the traceback into sys.exc_info()</span>
                    <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_error_html</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_error_html</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&quot;exc_info&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c"># in debug mode, try to send a traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;exc_info&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/title&gt;&quot;</span>
                        <span class="s">&quot;&lt;body&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span>
                        <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">})</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The local for the current session.</span>

<span class="sd">        Determined by either get_user_locale, which you can override to</span>
<span class="sd">        set the locale based on, e.g., a user preference stored in a</span>
<span class="sd">        database, or get_browser_locale, which uses the Accept-Language</span>
<span class="sd">        header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_locale&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_locale</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_browser_locale</span><span class="p">()</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span>

<div class="viewcode-block" id="RequestHandler.get_user_locale"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_user_locale">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override to determine the locale from the authenticated user.</span>

<span class="sd">        If None is returned, we fall back to get_browser_locale().</span>

<span class="sd">        This method should return a cyclone.locale.Locale object,</span>
<span class="sd">        most likely obtained via a call like cyclone.locale.get(&quot;en&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_browser_locale"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_browser_locale">[docs]</a>    <span class="k">def</span> <span class="nf">get_browser_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;en_US&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines the user&#39;s locale from Accept-Language header.</span>

<span class="sd">        See http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;Accept-Language&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">languages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Accept-Language&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">locales</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;q=&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">locales</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">locales</span><span class="p">:</span>
                <span class="n">locales</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">locales</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">codes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The authenticated user for this request.</span>

<span class="sd">        Determined by either get_current_user, which you can override to</span>
<span class="sd">        set the user based on, e.g., a cookie. If that method is not</span>
<span class="sd">        overridden, this method always returns None.</span>

<span class="sd">        We lazy-load the current user the first time this method is called</span>
<span class="sd">        and cache the result after that.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_current_user&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span>

<div class="viewcode-block" id="RequestHandler.get_current_user"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override to determine the current user from, e.g., a cookie.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_login_url"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_login_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_login_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override to customize the login URL based on the request.</span>

<span class="sd">        By default, we use the &#39;login_url&#39; application setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;login_url&quot;</span><span class="p">,</span> <span class="s">&quot;@cyclone.web.authenticated&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;login_url&quot;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RequestHandler.get_template_path"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.get_template_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override to customize template path for each handler.</span>

<span class="sd">        By default, we use the &#39;template_path&#39; application setting.</span>
<span class="sd">        Return None to load templates relative to the calling file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;template_path&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xsrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The XSRF-prevention token for the current user/session.</span>

<span class="sd">        To prevent cross-site request forgery, we set an &#39;_xsrf&#39; cookie</span>
<span class="sd">        and include the same &#39;_xsrf&#39; value as an argument with all POST</span>
<span class="sd">        requests. If the two do not match, we reject the form submission</span>
<span class="sd">        as a potential forgery.</span>

<span class="sd">        See http://en.wikipedia.org/wiki/Cross-site_request_forgery</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_xsrf_token&quot;</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_cookie_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>
                <span class="n">expires_days</span> <span class="o">=</span> <span class="mi">30</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="k">else</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_cookie_name</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">expires_days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span>

<div class="viewcode-block" id="RequestHandler.check_xsrf_cookie"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.check_xsrf_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">check_xsrf_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that the &#39;_xsrf&#39; cookie matches the &#39;_xsrf&#39; argument.</span>

<span class="sd">        To prevent cross-site request forgery, we set an &#39;_xsrf&#39;</span>
<span class="sd">        cookie and include the same value as a non-cookie</span>
<span class="sd">        field with all POST requests. If the two do not match, we</span>
<span class="sd">        reject the form submission as a potential forgery.</span>

<span class="sd">        The _xsrf value may be set as either a form field named _xsrf</span>
<span class="sd">        or in a custom HTTP header named X-XSRFToken or X-CSRFToken</span>
<span class="sd">        (the latter is accepted for compatibility with Django).</span>

<span class="sd">        See http://en.wikipedia.org/wiki/Cross-site_request_forgery</span>

<span class="sd">        Prior to release 1.1.1, this check was ignored if the HTTP header</span>
<span class="sd">        &quot;X-Requested-With: XMLHTTPRequest&quot; was present.  This exception</span>
<span class="sd">        has been shown to be insecure and has been removed.  For more</span>
<span class="sd">        information please see</span>
<span class="sd">        http://www.djangoproject.com/weblog/2011/feb/08/security/</span>
<span class="sd">        http://weblog.rubyonrails.org/2011/2/8/\</span>
<span class="sd">            csrf-protection-bypass-in-ruby-on-rails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_cookie_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Xsrftoken&quot;</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Csrftoken&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;&#39;_xsrf&#39; argument missing from POST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsrf_token</span> <span class="o">!=</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;XSRF cookie does not match POST argument&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.xsrf_form_html"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.xsrf_form_html">[docs]</a>    <span class="k">def</span> <span class="nf">xsrf_form_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An HTML &lt;input/&gt; element to be included with all POST forms.</span>

<span class="sd">        It defines the _xsrf input value, which we check on all POST</span>
<span class="sd">        requests to prevent cross-site request forgery. If you have set</span>
<span class="sd">        the &#39;xsrf_cookies&#39; application setting, you must include this</span>
<span class="sd">        HTML within all of your HTML forms.</span>

<span class="sd">        See check_xsrf_cookie() above for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;&lt;input type=&quot;hidden&quot; name=&quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsrf_cookie_name</span> <span class="o">+</span> \
                <span class="s">&#39;&quot; value=&quot;&#39;</span> <span class="o">+</span> <span class="n">escape</span><span class="o">.</span><span class="n">xhtml_escape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_token</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;/&gt;&#39;</span>
</div>
<div class="viewcode-block" id="RequestHandler.static_url"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.static_url">[docs]</a>    <span class="k">def</span> <span class="nf">static_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">include_host</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a static URL for the given relative static file path.</span>

<span class="sd">        This method requires you set the &#39;static_path&#39; setting in your</span>
<span class="sd">        application (which specifies the root directory of your static</span>
<span class="sd">        files).</span>

<span class="sd">        We append ?v=&lt;signature&gt; to the returned URL, which makes our</span>
<span class="sd">        static file handler set an infinite expiration header on the</span>
<span class="sd">        returned content. The signature is based on the content of the</span>
<span class="sd">        file.</span>

<span class="sd">        By default this method returns URLs relative to the current</span>
<span class="sd">        host, but if ``include_host`` is true the URL returned will be</span>
<span class="sd">        absolute.  If this handler has an ``include_host`` attribute,</span>
<span class="sd">        that value will be used as the default for all `static_url`</span>
<span class="sd">        calls that do not pass ``include_host`` as a keyword argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;static_path&quot;</span><span class="p">,</span> <span class="s">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="n">static_handler_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&quot;static_handler_class&quot;</span><span class="p">,</span> <span class="n">StaticFileHandler</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_host</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">include_host</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;include_host&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_host</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s">&quot;://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span> <span class="o">+</span> \
                   <span class="n">static_handler_class</span><span class="o">.</span><span class="n">make_static_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">static_handler_class</span><span class="o">.</span><span class="n">make_static_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base</span>
</div>
<div class="viewcode-block" id="RequestHandler.async_callback"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.async_callback">[docs]</a>    <span class="k">def</span> <span class="nf">async_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obsolete - catches exceptions from the wrapped function.</span>

<span class="sd">        This function is unnecessary since Tornado 1.1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Exception after headers written: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
</div>
<div class="viewcode-block" id="RequestHandler.require_setting"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.require_setting">[docs]</a>    <span class="k">def</span> <span class="nf">require_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="s">&quot;this feature&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raises an exception if the given app setting is not defined.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;You must define the &#39;</span><span class="si">%s</span><span class="s">&#39; setting in your &quot;</span>
                            <span class="s">&quot;application to use </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">feature</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RequestHandler.reverse_url"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.reverse_url">[docs]</a>    <span class="k">def</span> <span class="nf">reverse_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias for `Application.reverse_url`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.compute_etag"><a class="viewcode-back" href="../../web.html#cyclone.web.RequestHandler.compute_etag">[docs]</a>    <span class="k">def</span> <span class="nf">compute_etag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the etag header to be used for this request.</span>

<span class="sd">        May be overridden to provide custom etag implementations,</span>
<span class="sd">        or may return None to disable cyclone&#39;s default etag support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">:</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span>
</div>
    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transforms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes this request with the given output transforms.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_METHODS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">405</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="c"># If XSRF cookies are turned on, reject form submissions without</span>
            <span class="c"># the proper cookie</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s">&quot;OPTIONS&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;xsrf_cookies&quot;</span><span class="p">):</span>  <span class="c"># is True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;no_xsrf&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_xsrf_cookie</span><span class="p">()</span>
            <span class="n">defer</span><span class="o">.</span><span class="n">maybeDeferred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">)</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_execute_handler</span><span class="p">,</span>
                    <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_exception</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                    <span class="n">callbackArgs</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_deferred_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">(</span>
                              <span class="n">captureVars</span><span class="o">=</span><span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="o">.</span><span class="n">debug</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
                <span class="c"># This may degrade performance a bit, but at least avoid the</span>
                <span class="c"># server from breaking when someone call yield without</span>
                <span class="c"># decorating their handler with @inlineCallbacks.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;[warning] </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">() returned a generator. &quot;</span>
                        <span class="s">&quot;Perhaps it should be decorated with &quot;</span>
                        <span class="s">&quot;@inlineCallbacks.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_handler</span><span class="p">(</span><span class="n">defer</span><span class="o">.</span><span class="n">inlineCallbacks</span><span class="p">(</span><span class="n">function</span><span class="p">),</span>
                                              <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
            <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_handler</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_success</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_failure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifyFinish</span><span class="p">()</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_connection_close</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_finish</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_execute_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">utf8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span>
                      <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">)</span> <span class="o">+</span>
                      <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">reason</span><span class="p">)]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">utf8</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">utf8</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                  <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_headers</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_new_cookie&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="s">&quot;Set-Cookie: &quot;</span> <span class="o">+</span> <span class="n">cookie</span><span class="o">.</span><span class="n">OutputString</span><span class="p">(</span><span class="bp">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Logs the current request.</span>

<span class="sd">        Sort of deprecated since this functionality was moved to the</span>
<span class="sd">        Application, but left in place for the benefit of existing apps</span>
<span class="sd">        that have overridden this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_request_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">_handle_request_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># These are normally twisted.python.failure.Failure</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">TemplateError</span><span class="p">,</span>
                                    <span class="n">HTTPError</span><span class="p">,</span> <span class="n">HTTPAuthenticationRequired</span><span class="p">)):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateError</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">HTTPAuthenticationRequired</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">log_message</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Bad HTTP status code: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
                <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Uncaught exception</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ui_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_active_modules&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rendered</span>
        <span class="k">return</span> <span class="n">render</span>

    <span class="k">def</span> <span class="nf">_ui_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_headers_for_304</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 304 responses should not contain entity headers (defined in</span>
        <span class="c"># http://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html#sec7.1)</span>
        <span class="c"># not explicitly allowed by</span>
        <span class="c"># http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Allow&quot;</span><span class="p">,</span> <span class="s">&quot;Content-Encoding&quot;</span><span class="p">,</span> <span class="s">&quot;Content-Language&quot;</span><span class="p">,</span>
                   <span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="s">&quot;Content-MD5&quot;</span><span class="p">,</span> <span class="s">&quot;Content-Range&quot;</span><span class="p">,</span>
                   <span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;Last-Modified&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_header</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="asynchronous"><a class="viewcode-back" href="../../web.html#cyclone.web.asynchronous">[docs]</a><span class="k">def</span> <span class="nf">asynchronous</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrap request handler methods with this if they are asynchronous.</span>

<span class="sd">    If this decorator is given, the response is not finished when the</span>
<span class="sd">    method returns. It is up to the request handler to call self.finish()</span>
<span class="sd">    to terminate the HTTP request. Without this decorator, the request is</span>
<span class="sd">    automatically finished when the get() or post() method returns. ::</span>

<span class="sd">        from twisted.internet import reactor</span>

<span class="sd">        class MyRequestHandler(web.RequestHandler):</span>
<span class="sd">            @web.asynchronous</span>
<span class="sd">            def get(self):</span>
<span class="sd">                self.write(&quot;Processing your request...&quot;)</span>
<span class="sd">                reactor.callLater(5, self.do_something)</span>

<span class="sd">            def do_something(self):</span>
<span class="sd">                self.finish(&quot;done!&quot;)</span>

<span class="sd">    It may be used for Comet and similar push techniques.</span>
<span class="sd">    http://en.wikipedia.org/wiki/Comet_(programming)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_finish</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

</div>
<div class="viewcode-block" id="removeslash"><a class="viewcode-back" href="../../web.html#cyclone.web.removeslash">[docs]</a><span class="k">def</span> <span class="nf">removeslash</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use this decorator to remove trailing slashes from the request path.</span>

<span class="sd">    For example, a request to ``&#39;/foo/&#39;`` would redirect to ``&#39;/foo&#39;`` with</span>
<span class="sd">    this decorator. Your request handler mapping should use a regular</span>
<span class="sd">    expression like ``r&#39;/foo/*&#39;`` in conjunction with using the decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="s">&quot;DELETE&quot;</span><span class="p">):</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uri</span><span class="p">:</span>  <span class="c"># don&#39;t try to redirect &#39;/&#39; to &#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
                        <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span> <span class="o">+</span> <span class="s">&quot;?&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

</div>
<div class="viewcode-block" id="addslash"><a class="viewcode-back" href="../../web.html#cyclone.web.addslash">[docs]</a><span class="k">def</span> <span class="nf">addslash</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use this decorator to add a missing trailing slash to the request path.</span>

<span class="sd">    For example, a request to &#39;/foo&#39; would redirect to &#39;/foo/&#39; with this</span>
<span class="sd">    decorator. Your request handler mapping should use a regular expression</span>
<span class="sd">    like r&#39;/foo/?&#39; in conjunction with using the decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="s">&quot;DELETE&quot;</span><span class="p">):</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span> <span class="o">+</span> <span class="s">&quot;?&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

</div>
<div class="viewcode-block" id="Application"><a class="viewcode-back" href="../../web.html#cyclone.web.Application">[docs]</a><span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A collection of request handlers that make up a web application.</span>

<span class="sd">    Instances of this class are callable and can be passed directly to</span>
<span class="sd">    HTTPServer to serve the application::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r&quot;/&quot;, MainPageHandler),</span>
<span class="sd">        ])</span>
<span class="sd">        reactor.listenTCP(8888, application)</span>
<span class="sd">        reactor.run()</span>

<span class="sd">    The constructor for this class takes in a list of URLSpec objects</span>
<span class="sd">    or (regexp, request_class) tuples. When we receive requests, we</span>
<span class="sd">    iterate over the list in order and instantiate an instance of the</span>
<span class="sd">    first request class whose regexp matches the request path.</span>

<span class="sd">    Each tuple can contain an optional third element, which should be a</span>
<span class="sd">    dictionary if it is present. That dictionary is passed as keyword</span>
<span class="sd">    arguments to the contructor of the handler. This pattern is used</span>
<span class="sd">    for the StaticFileHandler below (note that a StaticFileHandler</span>
<span class="sd">    can be installed automatically with the static_path setting described</span>
<span class="sd">    below)::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r&quot;/static/(.*)&quot;, web.StaticFileHandler, {&quot;path&quot;: &quot;/var/www&quot;}),</span>
<span class="sd">        ])</span>

<span class="sd">    We support virtual hosts with the add_handlers method, which takes in</span>
<span class="sd">    a host regular expression as the first argument::</span>

<span class="sd">        application.add_handlers(r&quot;www\.myhost\.com&quot;, [</span>
<span class="sd">            (r&quot;/article/([0-9]+)&quot;, ArticleHandler),</span>
<span class="sd">        ])</span>

<span class="sd">    You can serve static files by sending the static_path setting as a</span>
<span class="sd">    keyword argument. We will serve those files from the /static/ URI</span>
<span class="sd">    (this is configurable with the static_url_prefix setting),</span>
<span class="sd">    and we will serve /favicon.ico and /robots.txt from the same directory.</span>
<span class="sd">    A custom subclass of StaticFileHandler can be specified with the</span>
<span class="sd">    static_handler_class setting.</span>

<span class="sd">    It is also possible to customize the error pages the application generates</span>
<span class="sd">    in case it does not find any handler for the incoming request by using the</span>
<span class="sd">    `error_handler` keyword argument. This allows for consistent error pages</span>
<span class="sd">    across the application.</span>

<span class="sd">    .. attribute:: settings</span>

<span class="sd">       Additonal keyword arguments passed to the constructor are saved in the</span>
<span class="sd">       `settings` dictionary, and are often referred to in documentation as</span>
<span class="sd">       &quot;application settings&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPConnection</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default_host</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">transforms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">transforms</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;gzip&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GZipContentEncoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ChunkedTransferEncoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">named_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">error_handler</span> <span class="ow">or</span> <span class="n">ErrorHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_host</span> <span class="o">=</span> <span class="n">default_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">ObjectDict</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui_modules</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;linkify&quot;</span><span class="p">:</span> <span class="n">_linkify</span><span class="p">,</span>
                           <span class="s">&quot;xsrf_form_html&quot;</span><span class="p">:</span> <span class="n">_xsrf_form_html</span><span class="p">,</span>
                           <span class="s">&quot;Template&quot;</span><span class="p">:</span> <span class="n">TemplateModule</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_modules</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;ui_modules&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_methods</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;ui_methods&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">if</span> <span class="s">&quot;static_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;static_path&quot;</span><span class="p">]</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">handlers</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">static_url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;static_url_prefix&quot;</span><span class="p">,</span>
                                             <span class="s">&quot;/static/&quot;</span><span class="p">)</span>
            <span class="n">static_handler_class</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;static_handler_class&quot;</span><span class="p">,</span>
                                                <span class="n">StaticFileHandler</span><span class="p">)</span>
            <span class="n">static_handler_args</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;static_handler_args&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">static_handler_args</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">static_url_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&quot;(.*)&quot;</span><span class="p">,</span>
                            <span class="s">r&quot;/(favicon\.ico)&quot;</span><span class="p">,</span> <span class="s">r&quot;/(robots\.txt)&quot;</span><span class="p">]:</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">static_handler_class</span><span class="p">,</span>
                                    <span class="n">static_handler_args</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_handlers</span><span class="p">(</span><span class="s">&quot;.*$&quot;</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>

<div class="viewcode-block" id="Application.add_handlers"><a class="viewcode-back" href="../../web.html#cyclone.web.Application.add_handlers">[docs]</a>    <span class="k">def</span> <span class="nf">add_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_pattern</span><span class="p">,</span> <span class="n">host_handlers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the given handlers to our handler list.</span>

<span class="sd">        Host patterns are processed sequentially in the order they were</span>
<span class="sd">        added. All matching patterns will be considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host_pattern</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">):</span>
            <span class="n">host_pattern</span> <span class="o">+=</span> <span class="s">&quot;$&quot;</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># The handlers with the wildcard host_pattern are a special</span>
        <span class="c"># case - they&#39;re added in the constructor but should have lower</span>
        <span class="c"># precedence than the more-precise handlers added later.</span>
        <span class="c"># If a wildcard handler group exists, it should always be last</span>
        <span class="c"># in the list, so insert new groups just before it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="s">&#39;.*$&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">host_pattern</span><span class="p">),</span> <span class="n">handlers</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">host_pattern</span><span class="p">),</span> <span class="n">handlers</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">host_handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TupleType</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">):</span>
                    <span class="c"># import the Module and instantiate the class</span>
                    <span class="c"># Must be a fully qualified name (module.ClassName)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">handler</span> <span class="o">=</span> <span class="n">import_object</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">reactor</span><span class="o">.</span><span class="n">callWhenRunning</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span>
                            <span class="s">&quot;Unable to load handler &#39;</span><span class="si">%s</span><span class="s">&#39; for &quot;</span>
                            <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">URLSpec</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_handlers</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Multiple handlers named </span><span class="si">%s</span><span class="s">; &quot;</span>
                            <span class="s">&quot;replacing previous value&quot;</span> <span class="o">%</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">named_handlers</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
</div>
<div class="viewcode-block" id="Application.add_transform"><a class="viewcode-back" href="../../web.html#cyclone.web.Application.add_transform">[docs]</a>    <span class="k">def</span> <span class="nf">add_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform_class</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the given OutputTransform to our transform list.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform_class</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_host_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handlers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
        <span class="c"># Look for default host if not behind load balancer (for debugging)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">and</span> <span class="s">&quot;X-Real-Ip&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handlers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_host</span><span class="p">):</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matches</span> <span class="ow">or</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_load_ui_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methods</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_methods</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                                       <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">methods</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_methods</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&quot;__call__&quot;</span><span class="p">)</span> \
                   <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ui_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="k">def</span> <span class="nf">_load_ui_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_modules</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                                       <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">modules</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_modules</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">UIModule</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ui_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called by HTTPServer to execute the request.&quot;&quot;&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">]</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_handlers</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">RedirectHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
                                      <span class="n">url</span><span class="o">=</span><span class="s">&quot;http://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_host</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">handler_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">spec</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                        <span class="c"># None-safe wrapper around url_unescape to handle</span>
                        <span class="c"># unmatched optional groups correctly</span>
                        <span class="k">def</span> <span class="nf">unquote</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">s</span>
                            <span class="k">return</span> <span class="n">escape</span><span class="o">.</span><span class="n">url_unescape</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                        <span class="c"># Pass matched groups to the handler.  Since</span>
                        <span class="c"># match.groups() includes both named and</span>
                        <span class="c"># unnamed groups,we want to use either groups</span>
                        <span class="c"># or groupdict but not both.</span>
                        <span class="c"># Note that args are passed as bytes so the handler can</span>
                        <span class="c"># decide what encoding to use.</span>

                        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groupindex</span><span class="p">:</span>
                            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">unquote</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">unquote</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">:</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="c"># In debug mode, re-compile templates and reload static files on every</span>
        <span class="c"># request so you don&#39;t need to restart to see changes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loader_lock</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">loader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">StaticFileHandler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handler</span>

<div class="viewcode-block" id="Application.reverse_url"><a class="viewcode-back" href="../../web.html#cyclone.web.Application.reverse_url">[docs]</a>    <span class="k">def</span> <span class="nf">reverse_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a URL path for handler named `name`</span>

<span class="sd">        The handler must be added to the application as a named URLSpec.</span>

<span class="sd">        Args will be substituted for capturing groups in the URLSpec regex.</span>
<span class="sd">        They will be converted to strings if necessary, encoded as utf8,</span>
<span class="sd">        and url-escaped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_handlers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> not found in named urls&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Application.log_request"><a class="viewcode-back" href="../../web.html#cyclone.web.Application.log_request">[docs]</a>    <span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a completed HTTP request to the logs.</span>

<span class="sd">        By default writes to the python root logger.  To change</span>
<span class="sd">        this behavior either subclass Application and override this method,</span>
<span class="sd">        or pass a function in the application settings dictionary as</span>
<span class="sd">        &#39;log_function&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;log_function&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;log_function&quot;</span><span class="p">](</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">request_time</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">request_time</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;[&quot;</span> <span class="o">+</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s">&quot;] &quot;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">get_status</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">handler</span><span class="o">.</span><span class="n">_request_summary</span><span class="p">()</span> <span class="o">+</span>
                <span class="s">&quot; </span><span class="si">%.2f</span><span class="s">ms&quot;</span> <span class="o">%</span> <span class="n">request_time</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="HTTPError"><a class="viewcode-back" href="../../web.html#cyclone.web.HTTPError">[docs]</a><span class="k">class</span> <span class="nc">HTTPError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An exception that will turn into an HTTP error response.</span>

<span class="sd">    :arg int status_code: HTTP status code.  Must be listed in</span>
<span class="sd">        `httplib.responses` unless the ``reason`` keyword argument is given.</span>
<span class="sd">    :arg string log_message: Message to be written to the log for this error</span>
<span class="sd">        (will not be shown to the user unless the `Application` is in debug</span>
<span class="sd">        mode).  May contain ``%s``-style placeholders, which will be filled</span>
<span class="sd">        in with remaining positional parameters.</span>
<span class="sd">    :arg string reason: Keyword-only argument.  The HTTP &quot;reason&quot; phrase</span>
<span class="sd">        to pass in the status line along with ``status_code``.  Normally</span>
<span class="sd">        determined automatically from ``status_code``, but can be used</span>
<span class="sd">        to use a non-standard numeric code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">=</span> <span class="n">log_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;reason&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="ow">or</span> \
                   <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="HTTPAuthenticationRequired"><a class="viewcode-back" href="../../web.html#cyclone.web.HTTPAuthenticationRequired">[docs]</a><span class="k">class</span> <span class="nc">HTTPAuthenticationRequired</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An exception that will turn into an HTTP 401, Authentication Required.</span>

<span class="sd">    The arguments are used to compose the ``WWW-Authenticate`` header.</span>
<span class="sd">    See http://en.wikipedia.org/wiki/Basic_access_authentication for details.</span>

<span class="sd">    :arg string auth_type: Authentication type (``Basic``, ``Digest``, etc)</span>
<span class="sd">    :arg string realm: Realm (Usually displayed by the browser)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">auth_type</span><span class="o">=</span><span class="s">&quot;Basic&quot;</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="s">&quot;Restricted Access&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">401</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">=</span> <span class="n">log_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">auth_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;realm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realm</span>

</div>
<div class="viewcode-block" id="ErrorHandler"><a class="viewcode-back" href="../../web.html#cyclone.web.ErrorHandler">[docs]</a><span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates an error response with status_code for all requests.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_xsrf_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># POSTs to an ErrorHandler don&#39;t actually have side effects,</span>
        <span class="c"># so we don&#39;t need to check the xsrf token.  This allows POSTs</span>
        <span class="c"># to the wrong url to return a 404 instead of 403.</span>
        <span class="k">pass</span>

</div>
<div class="viewcode-block" id="RedirectHandler"><a class="viewcode-back" href="../../web.html#cyclone.web.RedirectHandler">[docs]</a><span class="k">class</span> <span class="nc">RedirectHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Redirects the client to the given URL for all GET requests.</span>

<span class="sd">    You should provide the keyword argument &quot;url&quot; to the handler, e.g.::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r&quot;/oldpath&quot;, web.RedirectHandler, {&quot;url&quot;: &quot;/newpath&quot;}),</span>
<span class="sd">        ])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permanent</span> <span class="o">=</span> <span class="n">permanent</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_permanent</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="StaticFileHandler"><a class="viewcode-back" href="../../web.html#cyclone.web.StaticFileHandler">[docs]</a><span class="k">class</span> <span class="nc">StaticFileHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple handler that can serve static content from a directory.</span>

<span class="sd">    To map a path to this handler for a static data directory /var/www,</span>
<span class="sd">    you would add a line to your application like::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r&quot;/static/(.*)&quot;, web.StaticFileHandler, {&quot;path&quot;: &quot;/var/www&quot;}),</span>
<span class="sd">        ])</span>

<span class="sd">    The local root directory of the content should be passed as the &quot;path&quot;</span>
<span class="sd">    argument to the handler.</span>

<span class="sd">    To support aggressive browser caching, if the argument &quot;v&quot; is given</span>
<span class="sd">    with the path, we set an infinite HTTP expiration header. So, if you</span>
<span class="sd">    want browsers to cache a file indefinitely, send them to, e.g.,</span>
<span class="sd">    /static/images/myimage.png?v=xxx. Override ``get_cache_time`` method for</span>
<span class="sd">    more fine-grained cache control.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CACHE_MAX_AGE</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c"># 10 years</span>

    <span class="n">_static_hashes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>  <span class="c"># protects _static_hashes</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">default_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span> <span class="o">=</span> <span class="n">default_filename</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_static_hashes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">include_body</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">include_body</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_url_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="c"># os.path.abspath strips a trailing /</span>
        <span class="c"># it needs to be temporarily added back for requests to root/</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">abspath</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not in root static directory&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># need to look at the request.path here for when path is empty</span>
            <span class="c"># but there is some prefix to the path that was already</span>
            <span class="c"># trimmed by the routing</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a file&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat_result</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Last-Modified&quot;</span><span class="p">,</span> <span class="n">modified</span><span class="p">)</span>

        <span class="n">mime_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mime_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>

        <span class="n">cache_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cache_time</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">modified</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cache_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Expires&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                                       <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">cache_time</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Cache-Control&quot;</span><span class="p">,</span> <span class="s">&quot;max-age=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_time</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_extra_headers</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># Check the If-Modified-Since, and don&#39;t send the result if the</span>
        <span class="c"># content has not been modified</span>
        <span class="n">ims_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;If-Modified-Since&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ims_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">date_tuple</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate</span><span class="p">(</span><span class="n">ims_value</span><span class="p">)</span>
            <span class="n">if_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date_tuple</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">if_since</span> <span class="o">&gt;=</span> <span class="n">modified</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">include_body</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<div class="viewcode-block" id="StaticFileHandler.set_extra_headers"><a class="viewcode-back" href="../../web.html#cyclone.web.StaticFileHandler.set_extra_headers">[docs]</a>    <span class="k">def</span> <span class="nf">set_extra_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For subclass to add extra headers to the response&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="StaticFileHandler.get_cache_time"><a class="viewcode-back" href="../../web.html#cyclone.web.StaticFileHandler.get_cache_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_cache_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">modified</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override to customize cache control behavior.</span>

<span class="sd">        Return a positive number of seconds to trigger aggressive caching or 0</span>
<span class="sd">        to mark resource as cacheable, only.</span>

<span class="sd">        By default returns cache expiry of 10 years for resources requested</span>
<span class="sd">        with &quot;v&quot; argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CACHE_MAX_AGE</span> <span class="k">if</span> <span class="s">&quot;v&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span> <span class="k">else</span> <span class="mi">0</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="StaticFileHandler.make_static_url"><a class="viewcode-back" href="../../web.html#cyclone.web.StaticFileHandler.make_static_url">[docs]</a>    <span class="k">def</span> <span class="nf">make_static_url</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a versioned url for the given path.</span>

<span class="sd">        This method may be overridden in subclasses (but note that it is</span>
<span class="sd">        a class method rather than an instance method).</span>

<span class="sd">        ``settings`` is the `Application.settings` dictionary.  ``path``</span>
<span class="sd">        is the static path being requested.  The url returned should be</span>
<span class="sd">        relative to the current host.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">static_url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;static_url_prefix&#39;</span><span class="p">,</span> <span class="s">&#39;/static/&#39;</span><span class="p">)</span>
        <span class="n">version_hash</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">?v=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">static_url_prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">version_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">static_url_prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="StaticFileHandler.get_version"><a class="viewcode-back" href="../../web.html#cyclone.web.StaticFileHandler.get_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the version string to be used in static URLs.</span>

<span class="sd">        This method may be overridden in subclasses (but note that it</span>
<span class="sd">        is a class method rather than a static method).  The default</span>
<span class="sd">        implementation uses a hash of the file&#39;s contents.</span>

<span class="sd">        ``settings`` is the `Application.settings` dictionary and ``path``</span>
<span class="sd">        is the relative location of the requested asset on the filesystem.</span>
<span class="sd">        The returned value should be a string, or ``None`` if no version</span>
<span class="sd">        could be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">&quot;static_path&quot;</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">hashes</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_static_hashes</span>
            <span class="k">if</span> <span class="n">abs_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hashes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
                    <span class="n">hashes</span><span class="p">[</span><span class="n">abs_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Could not open static file </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                    <span class="n">hashes</span><span class="p">[</span><span class="n">abs_path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">hsh</span> <span class="o">=</span> <span class="n">hashes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hsh</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hsh</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="StaticFileHandler.parse_url_path"><a class="viewcode-back" href="../../web.html#cyclone.web.StaticFileHandler.parse_url_path">[docs]</a>    <span class="k">def</span> <span class="nf">parse_url_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a static URL path into a filesystem path.</span>

<span class="sd">        ``url_path`` is the path component of the URL with</span>
<span class="sd">        ``static_url_prefix`` removed.  The return value should be</span>
<span class="sd">        filesystem path relative to ``static_path``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">!=</span> <span class="s">&quot;/&quot;</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="n">url_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url_path</span>

</div></div>
<div class="viewcode-block" id="FallbackHandler"><a class="viewcode-back" href="../../web.html#cyclone.web.FallbackHandler">[docs]</a><span class="k">class</span> <span class="nc">FallbackHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A RequestHandler that wraps another HTTP server callback.</span>

<span class="sd">    Tornado has this to combine RequestHandlers and WSGI handlers, but it&#39;s</span>
<span class="sd">    not supported in cyclone and is just here for compatibily purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fallback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">fallback</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="bp">True</span>

</div>
<span class="k">class</span> <span class="nc">OutputTransform</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A transform modifies the result of an HTTP request (e.g., GZip encoding)</span>

<span class="sd">    A new transform instance is created for every request. See the</span>
<span class="sd">    ChunkedTransferEncoding example below if you want to implement a</span>
<span class="sd">    new Transform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">transform_first_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">transform_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">chunk</span>


<span class="k">class</span> <span class="nc">GZipContentEncoding</span><span class="p">(</span><span class="n">OutputTransform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies the gzip content encoding to the response.</span>

<span class="sd">    See http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.11</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CONTENT_TYPES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">,</span> <span class="s">&quot;text/css&quot;</span><span class="p">,</span> <span class="s">&quot;text/xml&quot;</span><span class="p">,</span>
        <span class="s">&quot;application/javascript&quot;</span><span class="p">,</span> <span class="s">&quot;application/x-javascript&quot;</span><span class="p">,</span>
        <span class="s">&quot;application/xml&quot;</span><span class="p">,</span> <span class="s">&quot;application/atom+xml&quot;</span><span class="p">,</span>
        <span class="s">&quot;text/javascript&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">,</span> <span class="s">&quot;application/xhtml+xml&quot;</span><span class="p">])</span>
    <span class="n">MIN_LENGTH</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">supports_http_1_1</span><span class="p">()</span> <span class="ow">and</span> \
            <span class="s">&quot;gzip&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Accept-Encoding&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">transform_first_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Vary&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Vary&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;, Accept-Encoding&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Vary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Accept-Encoding&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">_unicode</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTENT_TYPES</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="n">finishing</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_LENGTH</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">finishing</span> <span class="ow">or</span> <span class="s">&quot;Content-Length&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s">&quot;Content-Encoding&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;gzip&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&quot;Content-Length&quot;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">transform_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finishing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>


<span class="k">class</span> <span class="nc">ChunkedTransferEncoding</span><span class="p">(</span><span class="n">OutputTransform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies the chunked transfer encoding to the response.</span>

<span class="sd">    See http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.6.1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunking</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">supports_http_1_1</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">transform_first_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">):</span>
        <span class="c"># 304 responses have no body (not even a zero-length body), and so</span>
        <span class="c"># should not have either Content-Length or Transfer-Encoding headers.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunking</span> <span class="ow">and</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="mi">304</span><span class="p">:</span>
            <span class="c"># No need to chunk the output if a Content-Length is specified</span>
            <span class="k">if</span> <span class="s">&quot;Content-Length&quot;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="ow">or</span> <span class="s">&quot;Transfer-Encoding&quot;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunking</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;chunked&quot;</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">transform_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">finishing</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunking</span><span class="p">:</span>
            <span class="c"># Don&#39;t write out empty chunks because that means END-OF-STREAM</span>
            <span class="c"># with chunked encoding</span>
            <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\r\n</span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)),</span> <span class="n">block</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finishing</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">0</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">block</span>
        <span class="k">return</span> <span class="n">block</span>


<div class="viewcode-block" id="authenticated"><a class="viewcode-back" href="../../web.html#cyclone.web.authenticated">[docs]</a><span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorate methods with this to require that the user be logged in.&quot;&quot;&quot;</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_login_url</span><span class="p">()</span>
                <span class="k">if</span> <span class="s">&quot;?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
                        <span class="c"># if login url is absolute, make next absolute too</span>
                        <span class="n">next_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">next_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">?</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span>
                                     <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">next</span><span class="o">=</span><span class="n">next_url</span><span class="p">)))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

</div>
<div class="viewcode-block" id="UIModule"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule">[docs]</a><span class="k">class</span> <span class="nc">UIModule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A UI re-usable, modular unit on a page.</span>

<span class="sd">    UI modules often execute additional queries, and they can include</span>
<span class="sd">    additional CSS and JavaScript that will be included in the output</span>
<span class="sd">    page, which is automatically inserted on page render.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">ui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">current_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">locale</span>

<div class="viewcode-block" id="UIModule.render"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overridden in subclasses to return this module&#39;s output.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="UIModule.embedded_javascript"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.embedded_javascript">[docs]</a>    <span class="k">def</span> <span class="nf">embedded_javascript</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a JavaScript string that will be embedded in the page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UIModule.javascript_files"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.javascript_files">[docs]</a>    <span class="k">def</span> <span class="nf">javascript_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of JavaScript files required by this module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UIModule.embedded_css"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.embedded_css">[docs]</a>    <span class="k">def</span> <span class="nf">embedded_css</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a CSS string that will be embedded in the page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UIModule.css_files"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.css_files">[docs]</a>    <span class="k">def</span> <span class="nf">css_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of CSS files required by this module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UIModule.html_head"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.html_head">[docs]</a>    <span class="k">def</span> <span class="nf">html_head</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a CSS string that will be put in the &lt;head/&gt; element&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UIModule.html_body"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.html_body">[docs]</a>    <span class="k">def</span> <span class="nf">html_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an HTML string that will be put in the &lt;body/&gt; element&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="UIModule.render_string"><a class="viewcode-back" href="../../web.html#cyclone.web.UIModule.render_string">[docs]</a>    <span class="k">def</span> <span class="nf">render_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders a template and returns it as a string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">_linkify</span><span class="p">(</span><span class="n">UIModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">escape</span><span class="o">.</span><span class="n">linkify</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_xsrf_form_html</span><span class="p">(</span><span class="n">UIModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">xsrf_form_html</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TemplateModule</span><span class="p">(</span><span class="n">UIModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;UIModule that simply renders the given template.</span>

<span class="sd">    {% module Template(&quot;foo.html&quot;) %} is similar to {% include &quot;foo.html&quot; %},</span>
<span class="sd">    but the module version gets its own namespace (with kwargs passed to</span>
<span class="sd">    Template()) instead of inheriting the outer template&#39;s namespace.</span>

<span class="sd">    Templates rendered through this module also get access to UIModule&#39;s</span>
<span class="sd">    automatic javascript/css features.  Simply call set_resources</span>
<span class="sd">    inside the template and give it keyword arguments corresponding to</span>
<span class="sd">    the methods on UIModule: {{ set_resources(js_files=static_url(&quot;my.js&quot;)) }}</span>
<span class="sd">    Note that these resources are output once per template file, not once</span>
<span class="sd">    per instantiation of the template, so they must not depend on</span>
<span class="sd">    any arguments to the template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemplateModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="c"># keep resources in both a list and a dict to preserve order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;set_resources called with different &quot;</span>
                                     <span class="s">&quot;resources for the same template&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">set_resources</span><span class="o">=</span><span class="n">set_resources</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_list</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">embedded_javascript</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s">&quot;embedded_javascript&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">javascript_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s">&quot;javascript_files&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">embedded_css</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s">&quot;embedded_css&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">css_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s">&quot;css_files&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">html_head</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s">&quot;html_head&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">html_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s">&quot;html_body&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="URLSpec"><a class="viewcode-back" href="../../web.html#cyclone.web.URLSpec">[docs]</a><span class="k">class</span> <span class="nc">URLSpec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Specifies mappings between URLs and handlers.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handler_class</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a URLSpec.</span>

<span class="sd">        Parameters:</span>

<span class="sd">        pattern: Regular expression to be matched.  Any groups in the regex</span>
<span class="sd">            will be passed in to the handler&#39;s get/post/etc methods as</span>
<span class="sd">            arguments.</span>

<span class="sd">        handler_class: RequestHandler subclass to be invoked.</span>

<span class="sd">        kwargs (optional): A dictionary of additional arguments to be passed</span>
<span class="sd">            to the handler&#39;s constructor.</span>

<span class="sd">        name (optional): A name for this handler.  Used by</span>
<span class="sd">            Application.reverse_url.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">+=</span> <span class="s">&#39;$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groupindex</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groups</span><span class="p">),</span> \
            <span class="p">(</span><span class="s">&quot;groups in url regexes must either be all named or all &quot;</span>
             <span class="s">&quot;positional: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span> <span class="o">=</span> <span class="n">handler_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%r</span><span class="s">, </span><span class="si">%s</span><span class="s">, kwargs=</span><span class="si">%r</span><span class="s">, name=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a tuple (reverse string, group count) for a url.</span>

<span class="sd">        For example: Given the url pattern /([0-9]{4})/([a-z-]+)/, this method</span>
<span class="sd">        would return (&#39;/%s/%s/&#39;, 2).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">pattern</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groups</span> <span class="o">!=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">):</span>
            <span class="c"># The pattern is too complicated for our simplistic matching,</span>
            <span class="c"># so we can&#39;t support reversing it.</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;)&#39;</span> <span class="ow">in</span> <span class="n">fragment</span><span class="p">:</span>
                <span class="n">paren_loc</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">paren_loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">fragment</span><span class="p">[</span><span class="n">paren_loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> \
            <span class="s">&quot;Cannot reverse url regex &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">pattern</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_count</span><span class="p">,</span> <span class="s">&quot;required number of arguments &quot;</span>\
            <span class="s">&quot;not found&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>
        <span class="n">converted_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="n">bytes_type</span><span class="p">)):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">converted_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">escape</span><span class="o">.</span><span class="n">url_escape</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">converted_args</span><span class="p">)</span>
</div>
<span class="n">url</span> <span class="o">=</span> <span class="n">URLSpec</span>


<span class="k">def</span> <span class="nf">_time_independent_equals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">):</span>  <span class="c"># python3 byte strings</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">^</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c"># python2</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">|=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">create_signed_value</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">_create_signature</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">signature</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">decode_signed_value</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="mi">31</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">_create_signature</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_time_independent_equals</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">signature</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Invalid cookie signature </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">max_age_days</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Expired cookie </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">31</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">:</span>
        <span class="c"># _cookie_signature does not hash a delimiter between the</span>
        <span class="c"># parts of the cookie, so an attacker could transfer trailing</span>
        <span class="c"># digits from the payload to the timestamp without altering the</span>
        <span class="c"># signature.  For backwards compatibility, sanity-check timestamp</span>
        <span class="c"># here instead of modifying _cookie_signature.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Cookie timestamp in future; possible tampering </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Tampered cookie </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">_create_signature</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="o">*</span><span class="n">parts</span><span class="p">):</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">secret</span><span class="p">),</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">utf8</span><span class="p">(</span><span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">cyclone git-2013042301 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Alexandre Fiori.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>